name: BrowserStack WDIO Tests

on:
  # Label trigger - runs when a specific label is added to a PR
  pull_request:
    types: [labeled]
    branches:
      - main
      - develop
  
  # Commented out commit trigger - uncomment to enable
  # push:
  #   branches:
  #     - main
  #     - develop

# Add permissions for commenting on PRs
permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
  BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
  MM_TEST_ACCOUNT_SRP: ${{ secrets.MM_TEST_ACCOUNT_SRP }}

jobs:
  # android-tests:
  #   name: Android Tests
  #   runs-on: ubuntu-latest
  #   if: contains(github.event.pull_request.labels.*.name, 'run-android-tests')
    
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20.18.1'
  #         cache: 'yarn'

  #     - name: Install dependencies
  #       run: yarn install --frozen-lockfile

  #     - name: Setup BrowserStack Local
  #       uses: browserstack/github-actions/setup-local@master

  #     - name: Run Android Tests
  #       env:
  #         BROWSERSTACK_DEVICE: ${{ vars.BROWSERSTACK_ANDROID_DEVICE || 'Samsung Galaxy S23 Ultra' }}
  #         BROWSERSTACK_OS_VERSION: ${{ vars.BROWSERSTACK_ANDROID_OS_VERSION || '13.0' }}
  #         BROWSERSTACK_TAG_EXPRESSION: ${{ vars.BROWSERSTACK_ANDROID_TAGS || '@smoke and @androidApp' }}
  #       run: |
  #         yarn test:wdio:android:browserstack

  #     - name: Upload test results
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: android-test-results
  #         path: wdio/reports/
  #         retention-days: 30

  # ios-tests:
  #   name: iOS Tests
  #   runs-on: ubuntu-latest
  #   if: contains(github.event.pull_request.labels.*.name, 'run-ios-tests')
    
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20.18.1'
  #         cache: 'yarn'

  #     - name: Install dependencies
  #       run: yarn install --frozen-lockfile

  #     - name: Setup BrowserStack Local
  #       uses: browserstack/github-actions/setup-local@master

  #     - name: Run iOS Tests
  #       env:
  #         BROWSERSTACK_DEVICE: ${{ vars.BROWSERSTACK_IOS_DEVICE || 'iPhone 15 Pro' }}
  #         BROWSERSTACK_OS_VERSION: ${{ vars.BROWSERSTACK_IOS_OS_VERSION || '17.3' }}
  #         BROWSERSTACK_TAG_EXPRESSION: ${{ vars.BROWSERSTACK_IOS_TAGS || '@smoke and @iosApp' }}
  #         BROWSERSTACK_IOS_APP_URL: ${{ secrets.BROWSERSTACK_IOS_APP_URL }}
  #       run: |
  #         yarn test:wdio:ios:browserstack

  #     - name: Upload test results
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: ios-test-results
  #         path: wdio/reports/
  #         retention-days: 30

  # android-upgrade-tests:
  #   name: Android Upgrade Tests
  #   runs-on: ubuntu-latest
  #   if: contains(github.event.pull_request.labels.*.name, 'run-android-upgrade-tests')
    
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20.18.1'
  #         cache: 'yarn'

  #     - name: Install dependencies
  #       run: yarn install --frozen-lockfile

  #     - name: Setup BrowserStack Local
  #       uses: browserstack/github-actions/setup-local@master

  #     - name: Run Android Upgrade Tests
  #       env:
  #         BROWSERSTACK_DEVICE: ${{ vars.BROWSERSTACK_ANDROID_DEVICE || 'Google Pixel 6' }}
  #         BROWSERSTACK_OS_VERSION: ${{ vars.BROWSERSTACK_ANDROID_OS_VERSION || '12.0' }}
  #         BROWSERSTACK_ANDROID_APP_URL: ${{ secrets.BROWSERSTACK_ANDROID_APP_URL }}
  #       run: |
  #         yarn test:wdio:android:browserstack --upgrade

  #     - name: Upload test results
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: android-upgrade-test-results
  #         path: wdio/reports/
  #         retention-days: 30

  # ios-upgrade-tests:
  #   name: iOS Upgrade Tests
  #   runs-on: ubuntu-latest
  #   if: contains(github.event.pull_request.labels.*.name, 'run-ios-upgrade-tests')
    
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20.18.1'
  #         cache: 'yarn'

  #     - name: Install dependencies
  #       run: yarn install --frozen-lockfile

  #     - name: Setup BrowserStack Local
  #       uses: browserstack/github-actions/setup-local@master

  #     - name: Run iOS Upgrade Tests
  #       env:
  #         BROWSERSTACK_DEVICE: ${{ vars.BROWSERSTACK_IOS_DEVICE || 'iPhone 15 Pro' }}
  #         BROWSERSTACK_OS_VERSION: ${{ vars.BROWSERSTACK_IOS_OS_VERSION || '17.3' }}
  #         BROWSERSTACK_IOS_APP_URL: ${{ secrets.BROWSERSTACK_IOS_APP_URL }}
  #         PRODUCTION_APP_URL: ${{ secrets.PRODUCTION_APP_URL }}
  #       run: |
  #         yarn test:wdio:ios:browserstack --upgrade

  #     - name: Upload test results
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: ios-upgrade-test-results
  #         path: wdio/reports/
  #         retention-days: 30

  android-performance-tests:
    name: Android Performance Tests
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'run-android-performance-tests')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.1'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: BrowserStack Env Setup
        uses: browserstack/github-actions/setup-env@master
        with:
          username: ${{ secrets.BROWSERSTACK_USERNAME }}
          access-key: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          build-name: ${{ github.repository }}-${{ github.run_number }}
          project-name: ${{ github.repository }}

      - name: Start BrowserStack Local Tunnel (Custom)
        run: |
          echo "Downloading BrowserStack Local binary..."
          
          # Download BrowserStack Local binary for Linux
          curl -O https://www.browserstack.com/browserstack-local/BrowserStackLocal-linux-x64.zip
          
          # Unzip the binary
          unzip BrowserStackLocal-linux-x64.zip
          
          # Make it executable
          chmod +x BrowserStackLocal
          
          echo "Starting BrowserStack Local tunnel with binary..."
          echo "Local Identifier: $BROWSERSTACK_LOCAL_IDENTIFIER"
          
          # Start the tunnel in the background
          ./BrowserStackLocal --key $BROWSERSTACK_ACCESS_KEY --local-identifier $BROWSERSTACK_LOCAL_IDENTIFIER --verbose --force-local &
          
          # Store the process ID for cleanup
          echo $! > browserstack-local.pid
          
          echo "BrowserStack Local tunnel started in background"
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BROWSERSTACK_LOCAL_IDENTIFIER: ${{ github.run_id }}

      - name: Wait for BrowserStack Local
        run: |
          echo "Waiting for BrowserStack Local tunnel to be ready..."
          
          # Wait for tunnel to be established
          sleep 30
          
          echo "BrowserStack Local tunnel should be ready now"
          
          # Check if the process is still running
          if [ -f browserstack-local.pid ]; then
            PID=$(cat browserstack-local.pid)
            if ps -p $PID > /dev/null; then
              echo "✅ BrowserStack Local tunnel is running (PID: $PID)"
            else
              echo "❌ BrowserStack Local tunnel process is not running"
              exit 1
            fi
          else
            echo "❌ BrowserStack Local PID file not found"
            exit 1
          fi
          
          # Test local access
          echo "Testing local fixture server access..."
          
          # Get the correct fixture server port
          FIXTURE_PORT=$(node -e "const { getFixturesServerPort } = require('./e2e/fixtures/utils.js'); console.log(getFixturesServerPort());")
          echo "Fixture server port: $FIXTURE_PORT"
          
          if curl -s -o /dev/null -w "%{http_code}" "http://localhost:$FIXTURE_PORT/state.json" | grep -q "200"; then
            echo "✅ Local fixture server is accessible"
          else
            echo "❌ Local fixture server is not accessible"
          fi
          
          # Test through BrowserStack tunnel (using the tunnel's local identifier)
          echo "Testing fixture server through BrowserStack tunnel..."
          TUNNEL_URL="http://$BROWSERSTACK_LOCAL_IDENTIFIER.localhost.run:$FIXTURE_PORT/state.json"
          echo "Tunnel URL: $TUNNEL_URL"
          
          if curl -s -o /dev/null -w "%{http_code}" "$TUNNEL_URL" | grep -q "200"; then
            echo "✅ Fixture server is accessible through BrowserStack tunnel"
          else
            echo "⚠️ Fixture server may not be accessible through tunnel"
            echo "This is expected if the tunnel is still establishing"
          fi
          
          # Stop the test fixture server
          pkill -f "node.*fixture-server" || true

      - name: Run Android Performance Tests
        env:
          BROWSERSTACK_DEVICE: ${{ vars.BROWSERSTACK_ANDROID_DEVICE || 'Samsung Galaxy S23 Ultra' }}
          BROWSERSTACK_OS_VERSION: ${{ vars.BROWSERSTACK_ANDROID_OS_VERSION || '13.0' }}
          BROWSERSTACK_LOCAL: true
          BROWSERSTACK_LOCAL_IDENTIFIER: ${{ github.run_id }}
        run: |
          yarn test:wdio:android:browserstack --performance

      - name: Generate AppProfiling Comment
        id: profiling-comment
        if: always()
        run: |
          # Check if profiling data exists
          if [ -d "wdio/reports" ]; then
            echo "Checking for profiling data in wdio/reports..."
            
            # Use our enhanced script to handle multiple files
            if node -e "const { formatMultipleProfilingFiles } = require('./wdio/utils/formatProfilingComment.js'); console.log(formatMultipleProfilingFiles());" 2>/dev/null; then
              node -e "const { formatMultipleProfilingFiles } = require('./wdio/utils/formatProfilingComment.js'); console.log(formatMultipleProfilingFiles());" > comment.txt
            else
              # Fallback to finding latest file
              LATEST_PROFILING_FILE=$(find wdio/reports -name "profiling-data-*.json" -type f -printf '%T@ %p\n' 2>/dev/null | sort -n | tail -1 | cut -f2- -d" ")
              
              if [ -n "$LATEST_PROFILING_FILE" ] && [ -f "$LATEST_PROFILING_FILE" ]; then
                echo "Found profiling file: $LATEST_PROFILING_FILE"
                node wdio/utils/formatProfilingComment.js "$LATEST_PROFILING_FILE" > comment.txt
              else
                echo "No profiling data found"
                echo "## ❌ No AppProfiling Data Available" > comment.txt
                echo "" >> comment.txt
                echo "No profiling data was collected during this test run." >> comment.txt
              fi
            fi
          else
            echo "Reports directory not found"
            echo "## ❌ No AppProfiling Data Available" > comment.txt
            echo "" >> comment.txt
            echo "Reports directory not found. Tests may not have completed successfully." >> comment.txt
          fi
          
          # Read the comment and set it as output
          COMMENT=$(cat comment.txt)
          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            // Read the comment from the file
            const fs = require('fs');
            let comment;
            
            try {
              comment = fs.readFileSync('comment.txt', 'utf8');
            } catch (error) {
              comment = '## ❌ Error Reading AppProfiling Data\n\nCould not read profiling data from file.';
            }
            
            // Check if there's already a comment from this workflow
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('AppProfiling Metrics')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
              console.log('Updated existing AppProfiling comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('Created new AppProfiling comment');
            }

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-performance-test-results
          path: wdio/reports/
          retention-days: 30

      - name: Stop BrowserStack Local Tunnel
        if: always()
        run: |
          echo "Stopping BrowserStack Local tunnel..."
          
          # Check if PID file exists and stop the process
          if [ -f browserstack-local.pid ]; then
            PID=$(cat browserstack-local.pid)
            echo "Stopping BrowserStack Local process (PID: $PID)"
            
            # Try to stop gracefully first
            if kill -TERM $PID 2>/dev/null; then
              echo "Sent TERM signal to BrowserStack Local"
              
              # Wait for graceful shutdown
              sleep 5
              
              # Force kill if still running
              if ps -p $PID > /dev/null; then
                echo "Force killing BrowserStack Local process"
                kill -KILL $PID 2>/dev/null
              fi
            else
              echo "Process $PID not found or already stopped"
            fi
            
            # Clean up PID file
            rm -f browserstack-local.pid
          else
            echo "No PID file found, BrowserStack Local may not be running"
          fi
          
          # Also try to kill any remaining BrowserStackLocal processes
          pkill -f BrowserStackLocal || true
          
          echo "✅ BrowserStack Local tunnel cleanup completed"

  # ios-performance-tests:
  #   name: iOS Performance Tests
  #   runs-on: ubuntu-latest
  #   if: contains(github.event.pull_request.labels.*.name, 'run-ios-performance-tests')
    
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20.18.1'
  #         cache: 'yarn'

  #     - name: Install dependencies
  #       run: yarn install --frozen-lockfile

  #     - name: Setup BrowserStack Local
  #       uses: browserstack/github-actions/setup-local@master

  #     - name: Run iOS Performance Tests
  #       env:
  #         BROWSERSTACK_DEVICE: ${{ vars.BROWSERSTACK_IOS_DEVICE || 'iPhone 15 Pro' }}
  #         BROWSERSTACK_OS_VERSION: ${{ vars.BROWSERSTACK_IOS_OS_VERSION || '17.3' }}
  #         BROWSERSTACK_IOS_APP_URL: ${{ secrets.BROWSERSTACK_IOS_APP_URL }}
  #       run: |
  #         yarn test:wdio:ios:browserstack --performance

  #     - name: Upload test results
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: ios-performance-test-results
  #         path: wdio/reports/
  #         retention-days: 30 